{% extends 'transfers/base.html' %}

{% block h1_title %}{{page_title}}: {{ form.extent_files.value }} files, {{ form.extent_size.value|filesizeformat }}{% endblock %}

{% block content %}
<form role="form" method="post">
  {% csrf_token %}
  {% for hidden in form.hidden_fields %}
    {{hidden}}
  {% endfor %}
  <!-- {{form.resource}} -->
  <div class="card card--container card--grid-container mb-30">
    <div class="input--full-width">
      <h2>Target ArchivesSpace Resource</h2>
      <div id="resource_input_wrapper" class="input">
        <label for="resource_id">Related Resource *</label>
        <div id="resource_input">
          <input id="resource_id" type="text" aria-describedby="resource-id-help" aria-required="true"/>
          <div id="resource-id-help" class="input__help-text">Enter an ArchivesSpace resource ID (e.g. "231")</div>
          <button type="button" id="resource_find" class="btn btn--sm btn--blue mt-20">Find in ArchivesSpace</button>
        </div>
      </div>
      <div id="resource_result" style="display: none;">
        <h3>
          <div class="badge badge--blue" id="resource_title">
            Resource name
            <button id="resource_title_dismiss" class="btn btn--xs btn--gray" aria-label="remove resource">
              <span class="material-icon" aria-hidden="true">close</span>
            </button>
          </div>
        </h3>
      </div>
    </div>
  </div>

  <div class="card card--container card--grid-container pb-0 mb-30">
    <div class="input--full-width">
      <h2>Accession Details</h2>
      {% include 'accession/form_fields.html' with field=form.title %}
    </div>
    <div class="card card--container card--blue accession__card accession__dates">
      {% include 'accession/form_fields.html' with field=form.start_date%}
      {% include 'accession/form_fields.html' with field=form.end_date%}
    </div>
    {{ creators_formset.management_form }}
    {% for creator in creators_formset %}
      {% include 'accession/creators.html' %}
    {% endfor %}

    {{form.access_restriction}}
    {% include 'accession/form_fields.html' with field=form.description %}
    {% include 'accession/form_fields.html' with field=form.access_restrictions %}
    {% include 'accession/form_fields.html' with field=form.use_restrictions %}
  </div>

  <div class="card card--container mb-30">
    <h2>Rights Statements</h2>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Basis</th>
          <th>Rights Notes</th>
        </tr>
      </thead>
      <tbody>
        {% regroup rights_statements by rights_group as merged_rights %}
        {% for statement in merged_rights %}
        <tr>
          <td>{{statement.list.0.rights_basis}}</td>
          <td>{{statement.list.0.rights_info_notes}}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="card card--container mb-30">
    <h2>Transfers</h2>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Name</th>
          <th>Dates</th>
          <th>Size</th>
        </tr>
      </thead>
      <tbody>
        {% for t in transfers %}
        <tr>
          <td>{{t.bag_or_failed_name}}</td>
          <td>{{t.metadata.date_start|date:"M j, Y"}}-{{t.metadata.date_end|date:"M j, Y"}}</td>
          <td>{{t.machine_file_size|filesizeformat}}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <button type="submit" class="btn btn--md btn--blue">Submit</button>
  <a href="{% url 'accession:list' %}" class="btn btn--md btn--gray">Cancel</a>

</form>

{% endblock %}

{% block extra_js %}
<script type="text/javascript">
  url = "{% url 'accession:add' %}";

  $(function(){
    $('#resource_find').on('click', function(e){
      e.preventDefault();

      $('#messages').empty();
      $('#resource_input').fadeTo(200, 0.5);

      // Make GET request to find the resource
      $.get(url, {'resource_id': $('#resource_id').val()}, function(resp){
        if (resp.success){
          // Hide input one resource is found
          $('#resource_input_wrapper').hide()

          // Display the resource title and success alert
          $('#resource_title').text(resp.title)
          $('#id_resource').val(resp.uri) // store URI in hidden field
          $('#resource_result').show()
          displayMessage('blue', resp.title + ' was added as the target ArchiveSpace resource');

        } else {
          $('#resource_input').fadeTo(0, 1).show()
          displayMessage('orange', 'There was an error finding this resource in ArchivesSpace: '+ resp.error, false);
        }
      })
    });

    // Dismiss resource and show input again
    $('#resource_title_dismiss').on('click', function(){
      $('#resource_result').hide()
      $('#resource_title').text("")
      $('#id_resource').val("")
      $('#resource_input').fadeTo(0, 1).show()
    });
  });
</script>
{% endblock %}
